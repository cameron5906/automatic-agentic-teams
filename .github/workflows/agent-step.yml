name: Agent Step

on:
  workflow_call:
    inputs:
      agent_name:
        description: 'Name of the agent to run'
        required: true
        type: string
      phase:
        description: 'Phase of execution (pre, main, post, review)'
        required: true
        type: string
      issue_number:
        description: 'Issue number being processed'
        required: true
        type: string
      issue_context:
        description: 'Context summary from orchestrator'
        required: true
        type: string
      agent_prompts:
        description: 'JSON object containing prompts for each agent'
        required: true
        type: string
      planning_context:
        description: 'Context from planning agents'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number for review phase'
        required: false
        type: string
        default: ''
    outputs:
      result:
        description: 'Agent output result'
        value: ${{ jobs.run-agent.outputs.result }}
      success:
        description: 'Whether the agent completed successfully'
        value: ${{ jobs.run-agent.outputs.success }}

jobs:
  run-agent:
    name: Run ${{ inputs.agent_name }} (${{ inputs.phase }})
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.agent.outputs.result }}
      success: ${{ steps.agent.outputs.success }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
          token: ${{ secrets.CLAUDE_WORKFLOW_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin HEAD

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build MCP Discord
        working-directory: tools/mcp-discord
        run: |
          npm ci
          npm run build

      - name: Create MCP config
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "discord": {
                "command": "node",
                "args": ["${{ github.workspace }}/tools/mcp-discord/dist/index.js"],
                "env": {
                  "DISCORD_WEBHOOK_URL": "${{ secrets.DISCORD_DEV_WEBHOOK_URL }}",
                  "DISCORD_DEFAULT_CHANNEL_ID": "${{ vars.DISCORD_DEV_CHANNEL_ID || '1453129264118370434' }}",
                  "AGENT_NAME": "${{ inputs.agent_name }}"
                }
              }
            }
          }
          EOF

      - name: Load agent definition
        id: definition
        run: |
          DEFINITION_PATH="working/agents/definitions/${{ inputs.agent_name }}.md"
          if [ -f "$DEFINITION_PATH" ]; then
            DEFINITION=$(cat "$DEFINITION_PATH")
            echo "definition<<EOF" >> $GITHUB_OUTPUT
            echo "$DEFINITION" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "definition=No definition file found" >> $GITHUB_OUTPUT
          fi

      - name: Load agent memory
        id: memory
        run: |
          MEMORY_PATH="working/agents/memory/${{ inputs.agent_name }}/MEMORY.md"
          if [ -f "$MEMORY_PATH" ]; then
            MEMORY=$(cat "$MEMORY_PATH")
            echo "memory<<EOF" >> $GITHUB_OUTPUT
            echo "$MEMORY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "memory=No memory file found" >> $GITHUB_OUTPUT
          fi

      - name: Load supplementary memory files
        id: supplementary
        run: |
          MEMORY_DIR="working/agents/memory/${{ inputs.agent_name }}"
          SUPPLEMENTARY=""
          if [ -d "$MEMORY_DIR" ]; then
            for file in "$MEMORY_DIR"/*.md; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "MEMORY.md" ]; then
                SUPPLEMENTARY="$SUPPLEMENTARY\n\n## $(basename "$file" .md)\n$(cat "$file")"
              fi
            done
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUPPLEMENTARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find issue context file
        id: issue_file
        run: |
          ISSUE_FILE=$(find working/issues -name "${{ inputs.issue_number }} *.md" 2>/dev/null | head -1)
          if [ -n "$ISSUE_FILE" ]; then
            echo "path=$ISSUE_FILE" >> $GITHUB_OUTPUT
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract agent prompt
        id: prompt
        uses: actions/github-script@v7
        with:
          script: |
            const agentName = '${{ inputs.agent_name }}'.replace(/-/g, '_');
            const prompts = JSON.parse('${{ inputs.agent_prompts }}');
            const agentConfig = prompts[agentName] || {};
            core.setOutput('task', agentConfig.prompt || 'No specific task assigned');
            core.setOutput('phase_config', agentConfig.phase || 'main');

      - name: Build system prompt
        id: system
        run: |
          cat << 'EOF' > /tmp/system_prompt.txt
          # Agent: ${{ inputs.agent_name }}
          ## Phase: ${{ inputs.phase }}

          ## Your Definition
          ${{ steps.definition.outputs.definition }}

          ## Your Memory Guidelines
          ${{ steps.memory.outputs.memory }}

          ## Your Supplementary Memory
          ${{ steps.supplementary.outputs.files }}

          ## Working Directory
          Your memory space is at: working/agents/memory/${{ inputs.agent_name }}/
          You may read and write files in this directory to persist information.

          ## Issue Context
          ${{ inputs.issue_context }}

          ## Issue Context File
          The issue context file is at: ${{ steps.issue_file.outputs.path }}
          This file contains pre-planning information and should be updated with your findings.
          Post agents: Pay close attention to this file for context on what was planned.

          ## Planning Context
          ${{ inputs.planning_context }}

          ## Key Repository Files

          ### DEVLOG.md
          This is a LARGE development log file at the repository root. It contains session summaries of all prior work.
          - DO NOT read the entire file
          - To get recent context: grep for "## Session" and read the latest entry
          - You can refer to DEVLOG.md to understand what happened in previous sessions

          ### ABOUT.md
          Contains product information, business requirements, and milestones.
          Planning agents should reference this for alignment with business goals.

          ### working/issues/
          Contains context files for each issue being processed.
          Your current issue file: ${{ steps.issue_file.outputs.path }}

          ## Phase-Specific Instructions
          EOF

          case "${{ inputs.phase }}" in
            "pre")
              cat << 'PHASE_EOF' >> /tmp/system_prompt.txt
          You are running in the PRE phase. Your responsibilities:
          1. Gather context needed for downstream agents
          2. Document current state before changes
          3. Identify risks or blockers early
          4. Update your memory files with relevant findings
          5. Update the issue context file with your pre-planning findings
          6. Output a summary for use by other agents
          PHASE_EOF
              ;;
            "main")
              cat << 'PHASE_EOF' >> /tmp/system_prompt.txt
          You are running in the MAIN phase. Your responsibilities:
          1. Read the issue context file for pre-planning information
          2. Execute your primary task as assigned
          3. Make necessary changes to the codebase
          4. Commit changes with clear messages referencing the issue
          5. Update your memory files with decisions made
          6. Update the issue context file with implementation notes
          7. Output a summary of work completed
          PHASE_EOF
              ;;
            "post")
              cat << 'PHASE_EOF' >> /tmp/system_prompt.txt
          You are running in the POST phase. Your responsibilities:
          1. Read the issue context file carefully - it contains all pre-planning and implementation context
          2. Review and validate work done in earlier phases
          3. Make any necessary follow-up changes
          4. Update documentation and memory files
          5. Update the issue context file with validation results
          6. Ensure all artifacts are properly committed
          7. Output a summary of validation results
          PHASE_EOF
              ;;
            "review")
              cat << 'PHASE_EOF' >> /tmp/system_prompt.txt
          You are running in the REVIEW phase. Your responsibilities:
          1. Read the issue context file for full context on what was planned and implemented
          2. Review the pull request #${{ inputs.pr_number }}
          3. Check code quality and adherence to standards
          4. Verify tests pass and coverage is adequate
          5. Leave review comments as appropriate
          6. Approve or request changes
          PHASE_EOF
              ;;
          esac

          SYSTEM_PROMPT=$(cat /tmp/system_prompt.txt)
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$SYSTEM_PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run agent
        id: agent
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CLAUDE_WORKFLOW_TOKEN }}
          claude_args: --mcp-config /tmp/mcp-config.json
          system_prompt: ${{ steps.system.outputs.prompt }}
          prompt: |
            ## Your Task
            ${{ steps.prompt.outputs.task }}

            ## Requirements
            1. Complete your assigned task thoroughly
            2. Read the issue context file at: ${{ steps.issue_file.outputs.path }}
            3. Update your memory files as appropriate
            4. Update the issue context file with your work/findings
            5. Commit any code changes with proper messages
            6. Output a JSON summary of your work

            ## Discord Updates (via MCP)
            You have access to the `discord_post_dev_update` MCP tool to post updates to the #dev Discord channel.
            Post 1-3 updates during your session for any of the following:
            - **tech_debt**: Observations about technical debt you encounter
            - **progress**: Significant milestones or task completions
            - **delay**: Blockers or reasons for delays
            - **thinking**: Significant decisions or reasoning steps

            Keep messages concise (1-2 sentences). Example:
            - tech_debt: "Found duplicated validation logic across 3 controllers - would benefit from extraction to shared utility"
            - progress: "Completed user authentication module with JWT token refresh"
            - delay: "Blocked on missing API documentation for external payment service"
            - thinking: "Choosing repository pattern over direct DB access for better testability"

            ## Expected Output Format
            After completing your work, output a JSON summary:
            ```json
            {
              "success": boolean,
              "summary": "Brief description of what was done",
              "files_changed": [],
              "commits_made": [],
              "memory_updated": boolean,
              "issue_context_updated": boolean,
              "blockers": [],
              "notes_for_next_agent": ""
            }
            ```

      - name: Parse agent output
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.agent.outputs.result }}`;
            try {
              const jsonMatch = output.match(/```json\s*([\s\S]*?)\s*```/);
              if (jsonMatch) {
                const result = JSON.parse(jsonMatch[1]);
                core.setOutput('success', result.success);
                core.setOutput('result', JSON.stringify(result));
              } else {
                core.setOutput('success', true);
                core.setOutput('result', JSON.stringify({ summary: output }));
              }
            } catch (e) {
              core.setOutput('success', true);
              core.setOutput('result', JSON.stringify({ summary: output }));
            }

      - name: Commit updates
        run: |
          git add working/agents/memory/${{ inputs.agent_name }}/ || true
          git add working/issues/ || true
          if ! git diff --staged --quiet; then
            git commit -m "chore(${{ inputs.agent_name }}): update agent memory and issue context [${{ inputs.phase }}]

            Issue: #${{ inputs.issue_number }}"
            git push
          fi
